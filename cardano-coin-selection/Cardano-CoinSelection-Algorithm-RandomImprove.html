<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head id="head" data-base-url=".."><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Cardano.CoinSelection.Algorithm.RandomImprove</title><link href="../linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="../quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="../haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">cardano-coin-selection-1.0.1: Algorithms for coin selection and fee balancing.</span><ul class="links" id="page-menu"><li><a href="src/Cardano.CoinSelection.Algorithm.RandomImprove.html">Source</a></li><li><a href="../index.html">Contents</a></li><li><a href="../doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th valign="top">Copyright</th><td>&#169; 2018-2024 Intersect MBO</td></tr><tr><th>License</th><td>Apache-2.0</td></tr><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Cardano.CoinSelection.Algorithm.RandomImprove</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module contains an implementation of the <strong>Random-Improve</strong> coin
 selection algorithm.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:randomImprove">randomImprove</a> :: (<a href="../base/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> i, <a href="../base/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> o, MonadRandom m) =&gt; <a href="Cardano-CoinSelection.html#t:CoinSelectionAlgorithm" title="Cardano.CoinSelection">CoinSelectionAlgorithm</a> i o m</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:randomImprove" class="def">randomImprove</a> :: (<a href="../base/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> i, <a href="../base/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> o, MonadRandom m) =&gt; <a href="Cardano-CoinSelection.html#t:CoinSelectionAlgorithm" title="Cardano.CoinSelection">CoinSelectionAlgorithm</a> i o m <a href="src/Cardano.CoinSelection.Algorithm.RandomImprove.html#randomImprove" class="link">Source</a> <a href="#v:randomImprove" class="selflink">#</a></p><div class="doc"><p>An implementation of the <strong>Random-Improve</strong> coin selection algorithm.</p><h1>Overview</h1><p>The <strong>Random-Improve</strong> coin selection algorithm works in <strong>two phases</strong>, by
 <em>first</em> selecting UTxO entries <em>at random</em> to pay for each of the given
 outputs, and <em>then</em> attempting to <em>improve</em> upon each of the selections.</p><h3>Phase 1: Random Selection</h3><p><strong>In this phase, the algorithm randomly selects a minimal set of UTxO</strong>
 <strong>entries to pay for each of the given outputs.</strong></p><p>During this phase, the algorithm:</p><ul><li>processes outputs in <em>descending order of coin value</em>.</li><li>maintains a <em>remaining UTxO set</em>, initially equal to the given
      <em>UTxO set</em> parameter.</li></ul><p>For each output of value <strong><em>v</em></strong>, the algorithm <em>randomly</em> selects entries
 from the <em>remaining UTxO set</em>, until the total value of selected entries is
 greater than or equal to <strong><em>v</em></strong>. The selected entries are then associated
 with that output, and removed from the <em>remaining UTxO set</em>.</p><p>This phase ends when every output has been associated with a selection of
 UTxO entries.</p><p>However, if the remaining UTxO set is completely exhausted before all
 outputs can be processed, the algorithm terminates with an error.</p><h3>Phase 2: Improvement</h3><p><strong>In this phase, the algorithm attempts to improve upon each of the UTxO</strong>
 <strong>selections made in the previous phase, by conservatively expanding the</strong>
 <strong>selection made for each output.</strong></p><p>During this phase, the algorithm:</p><ul><li>processes outputs in <em>ascending order of coin value</em>.</li><li>continues to maintain the <em>remaining UTxO set</em> produced by the previous
      phase.</li><li>maintains an <em>accumulated coin selection</em>, which is initially <em>empty</em>.</li></ul><p>For each output of value <strong><em>v</em></strong>, the algorithm:</p><ol><li value="1"><p><strong>Calculates a <em>target range</em></strong> for the total value of inputs used to
      pay for that output, defined by the triplet:</p><p>(<em>minimum</em>, <em>ideal</em>, <em>maximum</em>) = (<em>v</em>, <em>2v</em>, <em>3v</em>)</p></li><li value="2"><p><strong>Attempts to <em>improve</em> upon the <em>existing UTxO selection</em></strong> for that
      output, by repeatedly selecting additional entries at random from the
      <em>remaining UTxO set</em>, stopping when the selection can be improved upon
      no further.</p><p>A selection with value <em>v1</em> is considered to be an <em>improvement</em> over a
selection with value <em>v0</em> if <strong>all</strong> of the following conditions are
satisfied:</p><ul><li><p><strong>Condition 1</strong>: we have moved closer to the <em>ideal</em> value:</p><p>abs (<em>ideal</em> &#8722; <em>v1</em>) &lt; abs (<em>ideal</em> &#8722; <em>v0</em>)</p></li><li><p><strong>Condition 2</strong>: we have not exceeded the <em>maximum</em> value:</p><p><em>v1</em> &#8804; <em>maximum</em></p></li><li><strong>Condition 3</strong>: when counting cumulatively across all outputs
 considered so far, we have not selected more than the <em>maximum</em> number
 of UTxO entries specified by <code><a href="Cardano-CoinSelection.html#v:limit" title="Cardano.CoinSelection">limit</a></code>.</li></ul></li><li value="3"><strong>Creates a <em>change value</em></strong> for the output, equal to the total value
      of the <em>final UTxO selection</em> for that output minus the value <em>v</em> of
      that output.</li><li value="4"><p><strong>Updates the <em>accumulated coin selection</em></strong>:</p><ul><li>Adds the <em>output</em> to <code><a href="Cardano-CoinSelection.html#v:outputs" title="Cardano.CoinSelection">outputs</a></code>.</li><li>Adds the <em>improved UTxO selection</em> to <code><a href="Cardano-CoinSelection.html#v:inputs" title="Cardano.CoinSelection">inputs</a></code>.</li><li>Adds the <em>change value</em> to <code><a href="Cardano-CoinSelection.html#v:change" title="Cardano.CoinSelection">change</a></code>.</li></ul></li></ol><p>This phase ends when every output has been processed, <strong>or</strong> when the
 <em>remaining UTxO set</em> has been exhausted, whichever occurs sooner.</p><h1>Termination</h1><p>When both phases are complete, the algorithm terminates.</p><p>The <em>accumulated coin selection</em> and <em>remaining UTxO set</em> are returned to
 the caller.</p><h3>Failure Modes</h3><p>The algorithm terminates with an <strong>error</strong> if:</p><ol><li value="1"><p>The <em>total value</em> of the initial UTxO set (the amount of money
      <em>available</em>) is <em>less than</em> the total value of the output list (the
      amount of money <em>required</em>).</p><p>See: <strong><code><a href="Cardano-CoinSelection.html#t:InputValueInsufficientError" title="Cardano.CoinSelection">InputValueInsufficientError</a></code></strong>.</p></li><li value="2"><p>The <em>number</em> of entries in the initial UTxO set is <em>smaller than</em> the
      number of requested outputs.</p><p>Due to the nature of the algorithm, <em>at least one</em> UTxO entry is
required <em>for each</em> output.</p><p>See: <strong><code><a href="Cardano-CoinSelection.html#t:InputCountInsufficientError" title="Cardano.CoinSelection">InputCountInsufficientError</a></code></strong>.</p></li><li value="3"><p>Due to the particular <em>distribution</em> of values within the initial UTxO
      set, the algorithm depletes all entries from the UTxO set <em>before</em> it
      is able to pay for all requested outputs.</p><p>See: <strong><code><a href="Cardano-CoinSelection.html#t:InputsExhaustedError" title="Cardano.CoinSelection">InputsExhaustedError</a></code></strong>.</p></li><li value="4"><p>The <em>number</em> of UTxO entries needed to pay for the requested outputs
      would <em>exceed</em> the upper limit specified by <code><a href="Cardano-CoinSelection.html#v:limit" title="Cardano.CoinSelection">limit</a></code>.</p><p>See: <strong><code><a href="Cardano-CoinSelection.html#t:InputLimitExceededError" title="Cardano.CoinSelection">InputLimitExceededError</a></code></strong>.</p></li></ol><h1>Motivating Principles</h1><p>There are several motivating principles behind the design of the algorithm.</p><h3>Principle 1: Dust Management</h3><p>The probability that random selection will choose dust entries from a UTxO
 set increases with the proportion of dust in the set.</p><p>Therefore, for a UTxO set with a large amount of dust, there's a high
 probability that a random subset will include a large amount of dust.</p><h3>Principle 2: Change Management</h3><p>Ideally, coin selection algorithms should, over time, create a UTxO set that
 has <em>useful</em> outputs: outputs that will allow us to process future payments
 with a minimum number of inputs.</p><p>If for each payment request of value <strong><em>v</em></strong> we create a change output of
 <em>roughly</em> the same value <strong><em>v</em></strong>, then we will end up with a distribution of
 change values that matches the typical value distribution of payment
 requests.</p><h3>Principle 3: Performance Management</h3><p>Searching the UTxO set for additional entries to improve our change outputs
 is <em>only</em> useful if the UTxO set contains entries that are sufficiently
 small enough. But it is precisely when the UTxO set contains many small
 entries that it is less likely for a randomly-chosen UTxO entry to push the
 total above the upper bound.</p><p><em>Since: 1.0.0</em></p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>